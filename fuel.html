<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É VK Bridge -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>

    <script>
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      vkBridge.send('VKWebAppInit');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GAZ Smart Log</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap');
        :root {
            --primary-orange: #ff6600; 
            --glow-purple: rgba(138, 43, 226, 0.7);
            --glass-bg: #14141c; /* –ë–æ–ª–µ–µ –ø–ª–æ—Ç–Ω—ã–π —Ñ–æ–Ω –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–µ */
            --text-white: #ffffff;
            --money-green: #00ff9d;
            --bg-color: #1a1a1a; 
            --danger-red: #ff4d4d;
            --edit-blue: #00bfff;
        }
        body {
            margin: 0; padding: 0;
            font-family: 'Montserrat', sans-serif;
            min-height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-white);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* –°—Ç–∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
        .hero-title {
            position: absolute;
            top: 15%;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 2;
            text-shadow: 0 4px 10px rgba(0,0,0,0.8);
        }
        .hero-title h1 {
            font-size: 3em; /* –ö—Ä—É–ø–Ω—ã–π —Ç–µ–∫—Å—Ç */
            line-height: 1;
            margin: 0;
            color: white;
            text-transform: uppercase;
        }
        .hero-title span {
            color: var(--primary-orange);
            display: block; /* –ü–µ—Ä–µ–Ω–æ—Å –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É */
        }

        /* –ü–ö –í–ï–†–°–ò–Ø (–æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) */
        @media (min-width: 769px) {
            body {
                background-image: url('foto.jpg'); 
                background-size: cover;
                background-position: center;
                background-attachment: fixed;
                padding: 40px 0;
            }
            body::before {
                content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0, 0, 0, 0.7); z-index: -1; backdrop-filter: blur(4px);
            }
            .mobile-header-image { display: none; }
            .hero-title { display: none; } /* –°–∫—Ä—ã–≤–∞–µ–º –æ–≥—Ä–æ–º–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ –ü–ö */
        }

        /* –ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø */
        @media (max-width: 768px) {
            .mobile-header-image {
                display: block; 
                width: 100%; 
                /* –í—ã—Å–æ—Ç–∞ 85% —ç–∫—Ä–∞–Ω–∞, —á—Ç–æ–±—ã –ø–æ–º–µ—Å—Ç–∏–ª–∞—Å—å –¥–µ–≤—É—à–∫–∞ */
                height: 85vh; 
                position: relative; 
                z-index: 1;
            }
            .mobile-header-image img {
                width: 100%; 
                height: 100%; 
                display: block;
                /* cover + top center = –Ω–µ —Ä–µ–∂–µ—Ç –≥–æ–ª–æ–≤—É, –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ø–æ —à–∏—Ä–∏–Ω–µ */
                object-fit: cover; 
                object-position: top center;
                /* –ì—Ä–∞–¥–∏–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –≤ —Å–∞–º–æ–º –Ω–∏–∑—É, —á—Ç–æ–±—ã –æ–±—É–≤—å –±—ã–ª–∞ –≤–∏–¥–Ω–∞, –Ω–æ –±—ã–ª –ø–µ—Ä–µ—Ö–æ–¥ */
                mask-image: linear-gradient(to bottom, black 85%, transparent 100%);
                -webkit-mask-image: linear-gradient(to bottom, black 85%, transparent 100%);
            }
            /* –¢–µ–Ω—å —Å–Ω–∏–∑—É –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –∫–æ–Ω—Ç–µ–Ω—Ç */
            .mobile-header-image::after {
                content: '';
                position: absolute;
                bottom: 0; left: 0; right: 0;
                height: 150px;
                background: linear-gradient(to top, var(--bg-color), transparent);
                z-index: 1;
            }

            /* –ü–æ–¥–Ω–∏–º–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –∑–∞–∫—Ä—ã—Ç—å –Ω–æ–≥–∏ */
            .main-container { 
                margin-top: -60px; 
                position: relative; 
                z-index: 3; 
                padding: 0 15px; 
            }
            
            /* –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏, —Ç–∞–∫ –∫–∞–∫ –µ—Å—Ç—å –±–æ–ª—å—à–æ–π —Å–≤–µ—Ä—Ö—É */
            .calculator-card h1.calc-title { display: none; }
        }

        .main-container { width: 100%; max-width: 480px; display: flex; flex-direction: column; gap: 20px; margin-bottom: 50px; box-sizing: border-box;}
        
        .calculator-card, .history-card {
            background: var(--glass-bg); 
            /* –£–±–∏—Ä–∞–µ–º —Å–∏–ª—å–Ω—ã–π –±–ª—é—Ä, –¥–µ–ª–∞–µ–º —Ñ–æ–Ω –ø–ª–æ—Ç–Ω–µ–µ –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–µ */
            /* backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); */
            padding: 25px; 
            border-radius: 24px; /* –ë–æ–ª–µ–µ –∫—Ä—É–≥–ª—ã–µ —É–≥–ª—ã */
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            position: relative; 
            overflow: hidden;
        }
        
        /* –ê–∫—Ü–µ–Ω—Ç–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ (–æ—Ä–∞–Ω–∂–µ–≤–∞—è) */
        .calculator-card::before {
            content: ''; position: absolute; top: 20px; right: 20px; 
            width: 40px; height: 40px; 
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ff6600'%3E%3Cpath d='M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z'/%3E%3C/svg%3E") no-repeat center;
            opacity: 0.2;
        }

        h1.calc-title { text-align: center; text-transform: uppercase; font-weight: 900; margin: 0 0 20px 0; letter-spacing: 1px; font-size: 1.6em; }
        h1 span { color: var(--primary-orange); }
        
        /* –°—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ */
        .mode-toggle { display: flex; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 4px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .mode-btn { flex: 1; background: transparent; border: none; color: #888; padding: 12px; font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 0.8em; cursor: pointer; border-radius: 8px; transition: 0.3s; text-transform: uppercase; }
        .mode-btn.active { background: var(--primary-orange); color: white; box-shadow: 0 4px 15px rgba(255, 102, 0, 0.4); }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.75em; margin-bottom: 8px; color: #888; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        input { width: 100%; padding: 16px; box-sizing: border-box; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; color: white; font-size: 1.2em; font-family: 'Montserrat', sans-serif; font-weight: 600; transition: 0.3s; }
        input:focus { outline: none; border-color: var(--primary-orange); background: rgba(255, 255, 255, 0.1); }
        .hidden { display: none; }
        .row-2-col { display: flex; gap: 15px; } .row-2-col .input-group { flex: 1; }
        
        .btn-calc { width: 100%; padding: 20px; background: linear-gradient(135deg, #ff6600, #ff4500); color: white; border: none; border-radius: 14px; font-size: 1.2em; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: 0.3s; margin-top: 15px; box-shadow: 0 10px 25px rgba(255, 69, 0, 0.3); letter-spacing: 1px; }
        
        .results { margin-top: 25px; background: rgba(0,0,0,0.3); border-radius: 15px; padding: 20px; border: 1px solid rgba(255,255,255,0.05); display: none; }
        .result-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .result-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .result-label { font-size: 0.9em; color: #bbb; } .result-value { font-size: 1.2em; font-weight: 800; color: var(--text-white); } .money-val { color: var(--primary-orange); }
        
        .global-stats-container { margin-top: 20px; padding: 20px; background: #222; border-radius: 18px; text-align: center; border: 1px solid #333; display: none; }
        .global-stats-container span { display: block; font-size: 0.75em; color: #888; margin-bottom: 5px; letter-spacing: 2px; text-transform: uppercase;} .global-stats-container strong { font-size: 2em; color: #fff; display: block; margin-bottom: 10px;}
        .global-sub-stat { font-size: 0.9em; color: var(--money-green); font-weight: 600; padding-top: 10px; border-top: 1px solid #333; }
        
        .error-msg { color: #ff4d4d; background: rgba(255, 77, 77, 0.1); padding: 10px; border-radius: 8px; text-align: center; margin-top: 15px; display: none; }
        
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); } .history-header h3 { margin: 0; font-size: 1.1em; text-transform: uppercase; color: #fff; letter-spacing: 1px; }
        .btn-clear { background: transparent; border: 1px solid rgba(255, 77, 77, 0.5); color: #ff4d4d; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 0.75em; letter-spacing: 1px;}
        
        .table-container { max-height: 350px; overflow-y: auto; border-radius: 12px; background: rgba(0,0,0,0.2); }
        table { width: 100%; border-collapse: collapse; font-size: 0.8em; }
        th { text-align: left; padding: 14px 8px; background: rgba(0,0,0,0.6); position: sticky; top: 0; color: var(--primary-orange); text-transform: uppercase; font-size: 0.9em; }
        td { text-align: left; padding: 14px 8px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); color: #ddd; vertical-align: middle; }
        .td-money { color: var(--text-white); font-weight: bold; }
        
        tr.data-row { cursor: pointer; transition: background 0.2s; }
        tr.data-row:active { background: rgba(255,255,255,0.1); }
        .actions-row { display: none; background: rgba(0,0,0,0.3); }
        .actions-row.show { display: table-row; animation: fadeIn 0.3s; }
        .actions-wrapper { display: flex; gap: 10px; padding: 10px; justify-content: center; }
        .action-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 0.9em; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-edit { background: rgba(0, 191, 255, 0.15); color: var(--edit-blue); }
        .btn-del { background: rgba(255, 77, 77, 0.15); color: var(--danger-red); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hint-text { font-size: 0.7em; color: #666; text-align: center; margin-bottom: 10px; font-style: italic; }

    </style>
</head>
<body>
    <div class="mobile-header-image">
        <!-- –¢–µ–∫—Å—Ç –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∏ -->
        <div class="hero-title">
            <h1>–ë–æ—Ä—Ç–æ–≤–æ–π<br><span>–ñ—É—Ä–Ω–∞–ª</span></h1>
        </div>
        <img src="foto.jpg" alt="GAZ Header">
    </div>
    
    <div class="main-container">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ -->
        <div class="calculator-card">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –ü–ö –≤–µ—Ä—Å–∏–∏ (—Å–∫—Ä—ã—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö) -->
            <h1 class="calc-title">–†–∞—Å—Ö–æ–¥ <span>—Ç–æ–ø–ª–∏–≤–∞</span></h1>
            
            <div style="margin-bottom: 15px; text-align:center; text-transform:uppercase; color:#888; font-weight:800; font-size:0.8em; letter-spacing:1px;">–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞</div>
            
            <div class="mode-toggle">
                <button class="mode-btn active" id="btn-mode-odo" onclick="setMode('odo')">–û–¥–æ–º–µ—Ç—Ä</button>
                <button class="mode-btn" id="btn-mode-dist" onclick="setMode('dist')">–ü—Ä–æ–±–µ–≥ (Trip)</button>
            </div>
            
            <div id="mode-odo-container">
                <div class="row-2-col">
                    <div class="input-group"><label for="odo-prev">–°—Ç–∞—Ä—Ç (–∫–º)</label><input type="number" id="odo-prev" placeholder="10000"></div>
                    <div class="input-group"><label for="odo-curr">–§–∏–Ω–∏—à (–∫–º)</label><input type="number" id="odo-curr" placeholder="10450"></div>
                </div>
            </div>
            
            <div id="mode-dist-container" class="hidden">
                <div class="input-group"><label for="dist-direct">–ü—Ä–æ–µ—Ö–∞–Ω–æ (–∫–º)</label><input type="number" id="dist-direct" placeholder="450"></div>
            </div>
            
            <div class="row-2-col">
                <div class="input-group"><label for="fuel-liters">–õ–∏—Ç—Ä—ã</label><input type="number" id="fuel-liters" placeholder="60"></div>
                <div class="input-group"><label for="price-liter">–¶–µ–Ω–∞ –∑–∞ 1–ª</label><input type="number" id="price-liter" placeholder="55.50"></div>
            </div>
            
            <button class="btn-calc" onclick="calculateFuel()">–†–ê–°–°–ß–ò–¢–ê–¢–¨</button>
            
            <div id="error-box" class="error-msg"></div>
            
            <div class="results" id="results-box">
                <div class="result-item"><span class="result-label">–ü—Ä–æ–π–¥–µ–Ω–æ:</span><span class="result-value" id="res-distance">0 –∫–º</span></div>
                <div class="result-item"><span class="result-label">–†–∞—Å—Ö–æ–¥ / 100–∫–º:</span><span class="result-value" id="res-consumption">0 –ª</span></div>
                <div class="result-item"><span class="result-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–µ–∑–¥–∫–∏:</span><span class="result-value money-val" id="res-total-cost">0 ‚ÇΩ</span></div>
                <div class="result-item" style="border-top: 1px solid rgba(255,255,255,0.1); margin-top:5px; padding-top:10px;">
                    <span class="result-label" style="color: #fff; font-weight:bold;">–¶–µ–Ω–∞ 1 –∫–º –ø—É—Ç–∏:</span><span class="result-value money-val" id="res-km-cost" style="font-size: 1.4em;">0 ‚ÇΩ</span>
                </div>
            </div>
            
            <div class="global-stats-container" id="global-stats-box">
                <span>–°–†–ï–î–ù–ò–ô –ó–ê –í–°–ï –í–†–ï–ú–Ø</span><strong id="global-avg">0.00 –ª/100–∫–º</strong>
                <div id="global-cost-avg" class="global-sub-stat">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ 1 –∫–º: 0.00 ‚ÇΩ</div>
            </div>
        </div>

        <div class="history-card">
            <div class="history-header"><h3>–ò—Å—Ç–æ—Ä–∏—è</h3><button class="btn-clear" onclick="clearHistory()">–°–ë–†–û–°</button></div>
            <div class="hint-text">–ù–∞–∂–º–∏ –Ω–∞ –∑–∞–ø–∏—Å—å, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>–û–¥–æ</th>
                            <th>–ö–ú</th>
                            <th>–õ</th>
                            <th>–†—É–±</th>
                            <th>100–∫–º</th>
                        </tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        let calculationMode='odo';
        let historyData=JSON.parse(localStorage.getItem('gazFuelHistory'))||[];
        let lastPrice=localStorage.getItem('lastFuelPrice');

        window.onload=function(){
            renderHistoryTable();
            if(historyData.length>0){updateGlobalStats()}
            if(historyData.length>0 && historyData[0].currOdo){
                document.getElementById('odo-prev').value = historyData[0].currOdo;
            }
            if(lastPrice){document.getElementById('price-liter').value=lastPrice}
        };

        function setMode(e){
            calculationMode=e;
            const t=document.getElementById("btn-mode-odo"),l=document.getElementById("btn-mode-dist"),n=document.getElementById("mode-odo-container"),d=document.getElementById("mode-dist-container");
            document.getElementById("error-box").style.display="none";
            if("odo"===e){
                t.classList.add("active"); l.classList.remove("active"); n.classList.remove("hidden"); d.classList.add("hidden");
                if(historyData.length>0 && historyData[0].currOdo && document.getElementById('odo-prev').value === "") {
                     document.getElementById('odo-prev').value = historyData[0].currOdo;
                }
            } else {
                l.classList.add("active"); t.classList.remove("active"); d.classList.remove("hidden"); n.classList.add("hidden");
            }
        }

        function calculateFuel(){
            const liters=parseFloat(document.getElementById("fuel-liters").value);
            const price=parseFloat(document.getElementById("price-liter").value);
            const errorBox=document.getElementById("error-box");
            errorBox.style.display="none";
            
            let distance=0;
            let currentOdoValue=0;
            let lastOdo = historyData.length > 0 ? historyData[0].currOdo : 0;

            if("odo"===calculationMode){
                const odoPrev=parseFloat(document.getElementById("odo-prev").value);
                const odoCurr=parseFloat(document.getElementById("odo-curr").value);
                if(isNaN(odoPrev)||isNaN(odoCurr)) return void showError("–£–∫–∞–∂–∏—Ç–µ –æ–¥–æ–º–µ—Ç—Ä");
                if(odoCurr<=odoPrev) return void showError("–§–∏–Ω–∏—à > –°—Ç–∞—Ä—Ç–∞");
                distance = odoCurr - odoPrev;
                currentOdoValue = odoCurr;
            } else {
                const distDirect=parseFloat(document.getElementById("dist-direct").value);
                if(isNaN(distDirect)||distDirect<=0) return void showError("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–±–µ–≥");
                distance = distDirect;
                currentOdoValue = lastOdo + distance;
            }

            if(isNaN(liters)||liters<=0) return void showError("–í–≤–µ–¥–∏—Ç–µ –ª–∏—Ç—Ä—ã");
            if(isNaN(price)||price<=0) return void showError("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É");

            const consumption=liters/distance*100;
            const totalCost=liters*price;
            const costPerKm=totalCost/distance;

            document.getElementById("res-distance").innerText=distance.toFixed(1)+" –∫–º";
            document.getElementById("res-consumption").innerText=consumption.toFixed(2)+" –ª/100";
            document.getElementById("res-total-cost").innerText=Math.round(totalCost)+" ‚ÇΩ";
            document.getElementById("res-km-cost").innerText=costPerKm.toFixed(2)+" ‚ÇΩ";
            document.getElementById("results-box").style.display="block";

            localStorage.setItem("lastFuelPrice", price);

            const record={
                id:Date.now(),
                date:new Date().toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit"}),
                dist:distance,
                lit:liters,
                price:price,
                totalCost:totalCost,
                cons:consumption,
                currOdo:currentOdoValue
            };

            historyData.unshift(record);
            if(historyData.length>200) historyData.pop();

            saveAndRender();
            
            document.getElementById('odo-prev').value = currentOdoValue;
            document.getElementById('odo-curr').value = "";
            document.getElementById('dist-direct').value = "";
        }

        function renderHistoryTable(){
            const tbody=document.getElementById("history-body");
            tbody.innerHTML="";
            
            if(historyData.length===0){
                tbody.innerHTML='<tr><td colspan="5" style="text-align:center; color:#666; padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                document.getElementById("global-stats-box").style.display="none";
                return;
            }

            historyData.forEach(t=>{
                const costDisplay=t.totalCost?Math.round(t.totalCost):"-";
                const odoDisplay = t.currOdo ? t.currOdo : '-';
                
                // –°–¢–†–û–ö–ê –î–ê–ù–ù–´–•
                const rowData=`<tr class="data-row" onclick="toggleActions(${t.id})">
                    <td style="color:#fff; font-weight:bold;">${odoDisplay}</td>
                    <td>${t.dist.toFixed(0)}</td>
                    <td>${t.lit.toFixed(1)}</td>
                    <td class="td-money">${costDisplay}</td>
                    <td style="color:#fff; font-weight:bold;">${t.cons.toFixed(1)}</td>
                </tr>`;
                
                // –°–ö–†–´–¢–ê–Ø –°–¢–†–û–ö–ê –° –ö–ù–û–ü–ö–ê–ú–ò
                const rowActions=`<tr class="actions-row" id="act-${t.id}">
                    <td colspan="5">
                        <div class="actions-wrapper">
                            <button class="action-btn btn-edit" onclick="editItem(${t.id})">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                            <button class="action-btn btn-del" onclick="deleteItem(${t.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </td>
                </tr>`;
                
                tbody.insertAdjacentHTML("beforeend", rowData + rowActions);
            });
            updateGlobalStats();
        }

        function toggleActions(id) {
            document.querySelectorAll('.actions-row').forEach(row => {
                if(row.id !== 'act-' + id) row.classList.remove('show');
            });
            const row = document.getElementById('act-' + id);
            if(row) row.classList.toggle('show');
        }

        function deleteItem(id) {
            if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) {
                historyData = historyData.filter(item => item.id !== id);
                saveAndRender();
                if(historyData.length > 0 && historyData[0].currOdo) {
                     document.getElementById('odo-prev').value = historyData[0].currOdo;
                }
            }
        }

        function editItem(id) {
            if(confirm("–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è? –°—Ç–∞—Ä–∞—è –∑–∞–ø–∏—Å—å –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞.")) {
                const item = historyData.find(i => i.id === id);
                if(item) {
                    if (item.currOdo > 0) {
                        setMode('odo');
                        document.getElementById('odo-curr').value = item.currOdo;
                        document.getElementById('odo-prev').value = item.currOdo - item.dist;
                    } else {
                        setMode('dist');
                        document.getElementById('dist-direct').value = item.dist;
                    }
                    
                    document.getElementById('fuel-liters').value = item.lit;
                    document.getElementById('price-liter').value = item.price;

                    historyData = historyData.filter(i => i.id !== id);
                    saveAndRender();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
        }

        function updateGlobalStats(){
            if(0===historyData.length)return;
            document.getElementById("global-stats-box").style.display="block";
            let dist=0,lit=0,money=0;
            historyData.forEach(n=>{
                dist+=n.dist;
                lit+=n.lit;
                n.totalCost ? money+=n.totalCost : n.price&&n.lit&&(money+=n.price*n.lit)
            });
            if(dist>0){
                const avg=lit/dist*100;
                document.getElementById("global-avg").innerText=avg.toFixed(2)+" –ª/100–∫–º";
                const costKm=money/dist;
                document.getElementById("global-cost-avg").innerText="–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ 1 –∫–º: "+costKm.toFixed(2)+" ‚ÇΩ";
            }
        }

        function saveAndRender(){
            localStorage.setItem("gazFuelHistory",JSON.stringify(historyData));
            renderHistoryTable();
        }

        function clearHistory(){
            if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é?")){
                historyData=[];
                saveAndRender();
                document.getElementById("results-box").style.display="none";
                document.getElementById("global-stats-box").style.display="none";
                document.getElementById("odo-prev").value="";
                document.getElementById("odo-curr").value="";
                document.getElementById("dist-direct").value="";
                document.getElementById("fuel-liters").value="";
            }
        }

        function showError(e){
            const t=document.getElementById("error-box");
            t.innerText=e;
            t.style.display="block";
        }
    </script>
</body>
</html>
