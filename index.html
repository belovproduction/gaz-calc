<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É VK Bridge -->
<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>

<script>
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  vkBridge.send('VKWebAppInit');
</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAZ Smart Log</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap');
        :root {
            --primary-orange: #ff6600; 
            --glow-purple: rgba(138, 43, 226, 0.7);
            --glass-bg: rgba(20, 20, 28, 0.90);
            --text-white: #ffffff;
            --money-green: #00ff9d;
            --bg-color: #2b2e36; 
            --danger-red: #ff4d4d;
            --edit-blue: #00bfff;
        }
        body {
            margin: 0; padding: 0;
            font-family: 'Montserrat', sans-serif;
            min-height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-white);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        /* –ü–ö –í–ï–†–°–ò–Ø */
        @media (min-width: 769px) {
            body {
                background-image: url('foto.jpg'); 
                background-size: cover;
                background-position: center;
                background-attachment: fixed;
                padding: 40px 0;
            }
            body::before {
                content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0, 0, 0, 0.5); z-index: -1; backdrop-filter: blur(4px);
            }
            .mobile-header-image { display: none; }
        }
        /* –ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø */
        @media (max-width: 768px) {
            .mobile-header-image {
                display: block; width: 100%; height: auto; position: relative; z-index: 1;
            }
            .mobile-header-image img {
                width: 100%; height: auto; display: block;
                mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
                -webkit-mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
            }
            .main-container { margin-top: -30px; position: relative; z-index: 2; padding: 0 15px; }
        }
        .main-container { width: 100%; max-width: 480px; display: flex; flex-direction: column; gap: 20px; margin-bottom: 50px; }
        .calculator-card, .history-card {
            background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            padding: 25px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 0 1px rgba(255,255,255,0.2);
            border: 1px solid rgba(255, 255, 255, 0.1); position: relative; overflow: hidden;
        }
        .calculator-card::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, var(--glow-purple), var(--primary-orange));
        }
        h1 { text-align: center; text-transform: uppercase; font-weight: 900; margin: 0 0 20px 0; letter-spacing: 1px; font-size: 1.6em; }
        h1 span { color: var(--primary-orange); }
        .mode-toggle { display: flex; background: rgba(0,0,0,0.4); border-radius: 12px; padding: 4px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .mode-btn { flex: 1; background: transparent; border: none; color: #888; padding: 10px; font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 0.8em; cursor: pointer; border-radius: 8px; transition: 0.3s; text-transform: uppercase; }
        .mode-btn.active { background: var(--primary-orange); color: white; box-shadow: 0 4px 15px rgba(255, 102, 0, 0.4); }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.75em; margin-bottom: 6px; color: #ccc; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        input { width: 100%; padding: 14px; box-sizing: border-box; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; color: white; font-size: 1.2em; font-family: 'Montserrat', sans-serif; font-weight: 600; }
        input:focus { outline: none; border-color: var(--primary-orange); background: rgba(0, 0, 0, 0.6); }
        .hidden { display: none; }
        .row-2-col { display: flex; gap: 15px; } .row-2-col .input-group { flex: 1; }
        .btn-calc { width: 100%; padding: 18px; background: linear-gradient(135deg, #ff6600, #ff4500); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: 0.3s; margin-top: 10px; box-shadow: 0 10px 20px rgba(255, 69, 0, 0.3); }
        .results { margin-top: 25px; background: rgba(0,0,0,0.3); border-radius: 15px; padding: 15px; border: 1px solid rgba(255,255,255,0.05); display: none; }
        .result-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .result-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .result-label { font-size: 0.85em; color: #ccc; } .result-value { font-size: 1.2em; font-weight: 800; color: var(--primary-orange); } .money-val { color: var(--money-green); }
        .global-stats-container { margin-top: 20px; padding: 15px; background: linear-gradient(135deg, rgba(138, 43, 226, 0.15), rgba(0,0,0,0.3)); border-radius: 15px; text-align: center; border: 1px solid rgba(138, 43, 226, 0.3); display: none; }
        .global-stats-container span { display: block; font-size: 0.75em; color: #bbb; margin-bottom: 5px; letter-spacing: 2px; } .global-stats-container strong { font-size: 1.8em; color: #fff; display: block; margin-bottom: 8px;}
        .global-sub-stat { font-size: 0.85em; color: var(--money-green); font-weight: 600; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); }
        .error-msg { color: #ff4d4d; background: rgba(255, 77, 77, 0.1); padding: 10px; border-radius: 8px; text-align: center; margin-top: 15px; display: none; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); } .history-header h3 { margin: 0; font-size: 1em; text-transform: uppercase; color: #fff; }
        .btn-clear { background: transparent; border: 1px solid rgba(255, 77, 77, 0.5); color: #ff4d4d; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.75em; }
        
        .table-container { max-height: 350px; overflow-y: auto; border-radius: 10px; background: rgba(0,0,0,0.2); }
        table { width: 100%; border-collapse: collapse; font-size: 0.75em; } /* –®—Ä–∏—Ñ—Ç —á—É—Ç—å –º–µ–Ω—å—à–µ */
        th { text-align: left; padding: 12px 6px; background: rgba(0,0,0,0.6); position: sticky; top: 0; color: var(--primary-orange); text-transform: uppercase; }
        td { text-align: left; padding: 12px 6px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); color: #ddd; vertical-align: middle; }
        .td-money { color: var(--money-green); font-weight: bold; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ */
        tr.data-row { cursor: pointer; transition: background 0.2s; }
        tr.data-row:active { background: rgba(255,255,255,0.1); }
        
        /* –°–∫—Ä—ã—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ */
        .actions-row { display: none; background: rgba(0,0,0,0.3); }
        .actions-row.show { display: table-row; animation: fadeIn 0.3s; }
        .actions-wrapper { display: flex; gap: 10px; padding: 10px; justify-content: center; }
        .action-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 1.1em; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-edit { background: rgba(0, 191, 255, 0.2); color: var(--edit-blue); border: 1px solid rgba(0, 191, 255, 0.3); }
        .btn-del { background: rgba(255, 77, 77, 0.2); color: var(--danger-red); border: 1px solid rgba(255, 77, 77, 0.3); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hint-text { font-size: 0.7em; color: #666; text-align: center; margin-bottom: 10px; font-style: italic; }

    </style>
</head>
<body>
    <div class="mobile-header-image">
        <img src="foto.jpg" alt="GAZ Header">
    </div>
    <div class="main-container">
        <div class="calculator-card">
            <h1>–†–∞—Å—Ö–æ–¥ <span>—Ç–æ–ø–ª–∏–≤–∞</span></h1>
            <div class="mode-toggle">
                <button class="mode-btn active" id="btn-mode-odo" onclick="setMode('odo')">–û–¥–æ–º–µ—Ç—Ä</button>
                <button class="mode-btn" id="btn-mode-dist" onclick="setMode('dist')">–ü—Ä–æ–±–µ–≥ (Trip)</button>
            </div>
            <div id="mode-odo-container">
                <div class="row-2-col">
                    <div class="input-group"><label for="odo-prev">–°—Ç–∞—Ä—Ç (–∫–º)</label><input type="number" id="odo-prev" placeholder="10000"></div>
                    <div class="input-group"><label for="odo-curr">–§–∏–Ω–∏—à (–∫–º)</label><input type="number" id="odo-curr" placeholder="10450"></div>
                </div>
            </div>
            <div id="mode-dist-container" class="hidden">
                <div class="input-group"><label for="dist-direct">–ü—Ä–æ–µ—Ö–∞–Ω–æ (–∫–º)</label><input type="number" id="dist-direct" placeholder="450"></div>
            </div>
            <div class="row-2-col">
                <div class="input-group"><label for="fuel-liters">–õ–∏—Ç—Ä—ã</label><input type="number" id="fuel-liters" placeholder="60"></div>
                <div class="input-group"><label for="price-liter">–¶–µ–Ω–∞ –∑–∞ 1–ª</label><input type="number" id="price-liter" placeholder="55.50"></div>
            </div>
            <button class="btn-calc" onclick="calculateFuel()">–†–ê–°–°–ß–ò–¢–ê–¢–¨</button>
            <div id="error-box" class="error-msg"></div>
            <div class="results" id="results-box">
                <div class="result-item"><span class="result-label">–ü—Ä–æ–π–¥–µ–Ω–æ:</span><span class="result-value" id="res-distance">0 –∫–º</span></div>
                <div class="result-item"><span class="result-label">–†–∞—Å—Ö–æ–¥ / 100–∫–º:</span><span class="result-value" id="res-consumption">0 –ª</span></div>
                <div class="result-item"><span class="result-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–µ–∑–¥–∫–∏:</span><span class="result-value money-val" id="res-total-cost">0 ‚ÇΩ</span></div>
                <div class="result-item" style="border-top: 1px solid rgba(255,255,255,0.1); margin-top:5px; padding-top:10px;">
                    <span class="result-label" style="color: #fff; font-weight:bold;">–¶–µ–Ω–∞ 1 –∫–º –ø—É—Ç–∏:</span><span class="result-value money-val" id="res-km-cost" style="font-size: 1.4em;">0 ‚ÇΩ</span>
                </div>
            </div>
            <div class="global-stats-container" id="global-stats-box">
                <span>–°–†–ï–î–ù–ò–ô –ó–ê –í–°–ï –í–†–ï–ú–Ø</span><strong id="global-avg">0.00 –ª/100–∫–º</strong>
                <div id="global-cost-avg" class="global-sub-stat">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ 1 –∫–º: 0.00 ‚ÇΩ</div>
            </div>
        </div>
        <div class="history-card">
            <div class="history-header"><h3>–ò—Å—Ç–æ—Ä–∏—è</h3><button class="btn-clear" onclick="clearHistory()">–°–ë–†–û–°</button></div>
            <div class="hint-text">–ù–∞–∂–º–∏ –Ω–∞ –∑–∞–ø–∏—Å—å, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>–û–¥–æ</th>
                            <th>–ö–ú</th>
                            <th>–õ</th>
                            <th>–†—É–±</th>
                            <th>100–∫–º</th>
                        </tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        let calculationMode='odo';
        let historyData=JSON.parse(localStorage.getItem('gazFuelHistory'))||[];
        let lastPrice=localStorage.getItem('lastFuelPrice');

        window.onload=function(){
            renderHistoryTable();
            if(historyData.length>0){updateGlobalStats()}
            if(historyData.length>0 && historyData[0].currOdo){
                document.getElementById('odo-prev').value = historyData[0].currOdo;
            }
            if(lastPrice){document.getElementById('price-liter').value=lastPrice}
        };

        function setMode(e){
            calculationMode=e;
            const t=document.getElementById("btn-mode-odo"),l=document.getElementById("btn-mode-dist"),n=document.getElementById("mode-odo-container"),d=document.getElementById("mode-dist-container");
            document.getElementById("error-box").style.display="none";
            if("odo"===e){
                t.classList.add("active"); l.classList.remove("active"); n.classList.remove("hidden"); d.classList.add("hidden");
                if(historyData.length>0 && historyData[0].currOdo && document.getElementById('odo-prev').value === "") {
                     document.getElementById('odo-prev').value = historyData[0].currOdo;
                }
            } else {
                l.classList.add("active"); t.classList.remove("active"); d.classList.remove("hidden"); n.classList.add("hidden");
            }
        }

        function calculateFuel(){
            const liters=parseFloat(document.getElementById("fuel-liters").value);
            const price=parseFloat(document.getElementById("price-liter").value);
            const errorBox=document.getElementById("error-box");
            errorBox.style.display="none";
            
            let distance=0;
            let currentOdoValue=0;
            let lastOdo = historyData.length > 0 ? historyData[0].currOdo : 0;

            if("odo"===calculationMode){
                const odoPrev=parseFloat(document.getElementById("odo-prev").value);
                const odoCurr=parseFloat(document.getElementById("odo-curr").value);
                if(isNaN(odoPrev)||isNaN(odoCurr)) return void showError("–£–∫–∞–∂–∏—Ç–µ –æ–¥–æ–º–µ—Ç—Ä");
                if(odoCurr<=odoPrev) return void showError("–§–∏–Ω–∏—à > –°—Ç–∞—Ä—Ç–∞");
                distance = odoCurr - odoPrev;
                currentOdoValue = odoCurr;
            } else {
                const distDirect=parseFloat(document.getElementById("dist-direct").value);
                if(isNaN(distDirect)||distDirect<=0) return void showError("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–±–µ–≥");
                distance = distDirect;
                currentOdoValue = lastOdo + distance;
            }

            if(isNaN(liters)||liters<=0) return void showError("–í–≤–µ–¥–∏—Ç–µ –ª–∏—Ç—Ä—ã");
            if(isNaN(price)||price<=0) return void showError("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É");

            const consumption=liters/distance*100;
            const totalCost=liters*price;
            const costPerKm=totalCost/distance;

            document.getElementById("res-distance").innerText=distance.toFixed(1)+" –∫–º";
            document.getElementById("res-consumption").innerText=consumption.toFixed(2)+" –ª/100";
            document.getElementById("res-total-cost").innerText=Math.round(totalCost)+" ‚ÇΩ";
            document.getElementById("res-km-cost").innerText=costPerKm.toFixed(2)+" ‚ÇΩ";
            document.getElementById("results-box").style.display="block";

            localStorage.setItem("lastFuelPrice", price);

            const record={
                id:Date.now(),
                date:new Date().toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit"}),
                dist:distance,
                lit:liters,
                price:price,
                totalCost:totalCost,
                cons:consumption,
                currOdo:currentOdoValue
            };

            historyData.unshift(record);
            if(historyData.length>200) historyData.pop();

            saveAndRender();
            
            document.getElementById('odo-prev').value = currentOdoValue;
            document.getElementById('odo-curr').value = "";
            document.getElementById('dist-direct').value = "";
        }

        function renderHistoryTable(){
            const tbody=document.getElementById("history-body");
            tbody.innerHTML="";
            
            if(historyData.length===0){
                tbody.innerHTML='<tr><td colspan="5" style="text-align:center; color:#666; padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                document.getElementById("global-stats-box").style.display="none";
                return;
            }

            historyData.forEach(t=>{
                const costDisplay=t.totalCost?Math.round(t.totalCost):"-";
                const odoDisplay = t.currOdo ? t.currOdo : '-';
                
                // –°–¢–†–û–ö–ê –î–ê–ù–ù–´–•
                const rowData=`<tr class="data-row" onclick="toggleActions(${t.id})">
                    <td style="color:#fff; font-weight:bold;">${odoDisplay}</td>
                    <td>${t.dist.toFixed(0)}</td>
                    <td>${t.lit.toFixed(1)}</td>
                    <td class="td-money">${costDisplay}</td>
                    <td style="color:#fff; font-weight:bold;">${t.cons.toFixed(1)}</td>
                </tr>`;
                
                // –°–ö–†–´–¢–ê–Ø –°–¢–†–û–ö–ê –° –ö–ù–û–ü–ö–ê–ú–ò
                const rowActions=`<tr class="actions-row" id="act-${t.id}">
                    <td colspan="5">
                        <div class="actions-wrapper">
                            <button class="action-btn btn-edit" onclick="editItem(${t.id})">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                            <button class="action-btn btn-del" onclick="deleteItem(${t.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </td>
                </tr>`;
                
                tbody.insertAdjacentHTML("beforeend", rowData + rowActions);
            });
            updateGlobalStats();
        }

        function toggleActions(id) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ, –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ
            document.querySelectorAll('.actions-row').forEach(row => {
                if(row.id !== 'act-' + id) row.classList.remove('show');
            });
            
            // –¢–æ–≥–≥–ª–∏–º —Ç–µ–∫—É—â–∏–π
            const row = document.getElementById('act-' + id);
            if(row) row.classList.toggle('show');
        }

        function deleteItem(id) {
            if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) {
                historyData = historyData.filter(item => item.id !== id);
                saveAndRender();
                if(historyData.length > 0 && historyData[0].currOdo) {
                     document.getElementById('odo-prev').value = historyData[0].currOdo;
                }
            }
        }

        function editItem(id) {
            if(confirm("–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è? –°—Ç–∞—Ä–∞—è –∑–∞–ø–∏—Å—å –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞.")) {
                const item = historyData.find(i => i.id === id);
                if(item) {
                    if (item.currOdo > 0) {
                        setMode('odo');
                        document.getElementById('odo-curr').value = item.currOdo;
                        document.getElementById('odo-prev').value = item.currOdo - item.dist;
                    } else {
                        setMode('dist');
                        document.getElementById('dist-direct').value = item.dist;
                    }
                    
                    document.getElementById('fuel-liters').value = item.lit;
                    document.getElementById('price-liter').value = item.price;

                    historyData = historyData.filter(i => i.id !== id);
                    saveAndRender();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
        }

        function updateGlobalStats(){
            if(0===historyData.length)return;
            document.getElementById("global-stats-box").style.display="block";
            let dist=0,lit=0,money=0;
            historyData.forEach(n=>{
                dist+=n.dist;
                lit+=n.lit;
                n.totalCost ? money+=n.totalCost : n.price&&n.lit&&(money+=n.price*n.lit)
            });
            if(dist>0){
                const avg=lit/dist*100;
                document.getElementById("global-avg").innerText=avg.toFixed(2)+" –ª/100–∫–º";
                const costKm=money/dist;
                document.getElementById("global-cost-avg").innerText="–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ 1 –∫–º: "+costKm.toFixed(2)+" ‚ÇΩ";
            }
        }

        function saveAndRender(){
            localStorage.setItem("gazFuelHistory",JSON.stringify(historyData));
            renderHistoryTable();
        }

        function clearHistory(){
            if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é?")){
                historyData=[];
                saveAndRender();
                document.getElementById("results-box").style.display="none";
                document.getElementById("global-stats-box").style.display="none";
                document.getElementById("odo-prev").value="";
                document.getElementById("odo-curr").value="";
                document.getElementById("dist-direct").value="";
                document.getElementById("fuel-liters").value="";
            }
        }

        function showError(e){
            const t=document.getElementById("error-box");
            t.innerText=e;
            t.style.display="block";
        }
    </script>
</body>
</html>

